<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portfolio Management - Transactions</title>
    <link rel="stylesheet" href="../styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <nav class="sidebar">
            <div class="logo">
                <img src="../logo.png" alt="Logo">    
            </div>
            <ul class="nav-menu">
                <li class="nav-item active" data-page="dashboard" data-tooltip="Dashboard">
                    <a href="../index.html"><i class="fas fa-th-large"></i></a>
                </li>
                <li class="nav-item" data-page="assets" data-tooltip="Assets">
                    <a href="assets.html"><i class="fas fa-wallet"></i></a>
                </li>
                <li class="nav-item" data-page="transactions" data-tooltip="Transactions">
                    <a href="transactions.html"><i class="fas fa-exchange-alt"></i></a>
                </li>
                <li class="nav-item" data-page="invest" data-tooltip="Invest More">
                    <a href="invest.html"><i class="fas fa-chart-bar"></i></a>
                </li>
                <li class="nav-item" data-page="about" data-tooltip="About Us">
                    <a href="about.html"><i class="fas fa fa-users"></i></a>
                </li>
            </ul>
            <div class="settings-icon" data-tooltip="Settings">
                <a href="settings.html" data-tooltip="Settings">
                    <i class="fas fa-cog"></i>
                </a>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Transactions Page -->
            <div id="transactions" class="page active">
                <header class="page-header">
                    <h1>Transaction History</h1>
                    <p>Track all your investment activities</p>
                </header>

                <div class="transaction-filters-container">
                    <div class="transaction-filters">
                        <button class="filter-tab active">All</button>
                        <button class="filter-tab">Buy</button>
                        <button class="filter-tab">Sell</button>
                    </div>
                    <button class="export-btn" id="exportPdf">
                        <i class="fas fa-download"></i> Export
                    </button>
                </div>

                <div class="transaction-table">
                    <div class="table-header">
                        <div class="col">Date</div>
                        <div class="col">Type</div>
                        <div class="col">Asset</div>
                        <div class="col">Quantity</div>
                        <div class="col">Price</div>
                        <div class="col">Total</div>
                    </div>
                    <div class="table-body" id="transaction-body">
                        
                       
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="../script.js"></script>
    <script>
        // Set active navigation item
        document.addEventListener('DOMContentLoaded', function() {
            const currentPath = window.location.pathname;
            const navItems = document.querySelectorAll('.nav-item');
            
            navItems.forEach(item => {
                item.classList.remove('active');
                const link = item.querySelector('a');
                if (link) {
                    const linkPath = link.getAttribute('href');
                    const fileName = currentPath.split('/').pop();
                    // Check if current file matches the link
                    if (linkPath.includes(fileName) || 
                        (fileName === 'transactions.html' && linkPath === 'transactions.html')) {
                        item.classList.add('active');
                    }
                }
            });
        });

        // Export PDF functionality
        document.getElementById('exportPdf').addEventListener('click', function() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Add title
            doc.setFontSize(20);
            doc.text('Transaction History', 20, 20);
            
            // Add date
            doc.setFontSize(12);
            doc.text('Generated on: ' + new Date().toLocaleDateString(), 20, 35);
            
            // Prepare table data
            const tableData = [];
            const rows = document.querySelectorAll('.table-row');
            
            rows.forEach(row => {
                const cols = row.querySelectorAll('.col');
                const rowData = [
                    cols[0].textContent.trim(), // Date
                    cols[1].textContent.trim(), // Type
                    cols[2].querySelector('strong').textContent + ' - ' + cols[2].querySelector('span').textContent, // Asset
                    cols[3].textContent.trim(), // Quantity
                    cols[4].textContent.trim(), // Price
                    cols[5].textContent.trim()  // Total
                ];
                tableData.push(rowData);
            });
            
            // Create table headers
            const headers = ['Date', 'Type', 'Asset', 'Quantity', 'Price', 'Total'];
            
            // Add table
            let yPosition = 50;
            
            // Add headers
            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            let xPosition = 20;
            const columnWidths = [30, 20, 50, 25, 25, 30];
            
            headers.forEach((header, index) => {
                doc.text(header, xPosition, yPosition);
                xPosition += columnWidths[index];
            });
            
            // Add line under headers
            doc.line(20, yPosition + 2, 200, yPosition + 2);
            yPosition += 10;
            
            // Add data rows
            doc.setFont('helvetica', 'normal');
            tableData.forEach(row => {
                xPosition = 20;
                row.forEach((cell, index) => {
                    // Truncate long text to fit columns
                    let cellText = cell;
                    if (cellText.length > 20) {
                        cellText = cellText.substring(0, 17) + '...';
                    }
                    doc.text(cellText, xPosition, yPosition);
                    xPosition += columnWidths[index];
                });
                yPosition += 8;
                
                // Add new page if needed
                if (yPosition > 270) {
                    doc.addPage();
                    yPosition = 20;
                }
            });
            
            // Save the PDF
            doc.save('transaction-history.pdf');
        });
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const container = document.getElementById('transaction-body');
        
            try {
                const response = await fetch('http://localhost:8888/transactions');
                const data = await response.json();
        
                let html = '';
        
                data.forEach(txn => {
                    const date = new Date(txn.transaction_date).toLocaleDateString('en-US', {
                        year: 'numeric', month: 'short', day: 'numeric'
                    });
        
                    const price = txn.price.toFixed(2);
                    const total = txn.total_value.toFixed(2);
                    const quantity = txn.quantity;
                    const statusText = Math.random() > 0.7 ? 'Pending' : 'Completed';
                    const statusClass = statusText.toLowerCase();
        
                    const typeClass = txn.transaction_type.toLowerCase();
        
                    html += `
                        <div class="table-row">
                            <div class="col">${date}</div>
                            <div class="col">
                                <span class="transaction-type ${typeClass}">${txn.transaction_type}</span>
                            </div>
                            <div class="col">
                                <div class="asset-info">
                                    <strong>${txn.ticker_symbol || txn.asset_type}</strong>
                                    <span>${txn.asset_name}</span>
                                </div>
                            </div>
                            <div class="col">${quantity} ${txn.asset_type === 'stock' ? 'shares' : 'units'}</div>
                            <div class="col">$${price}</div>
                            <div class="col">$${total}</div>
                            
                        </div>
                    `;
                });
        
                container.innerHTML = html;
        
            } catch (err) {
                container.innerHTML = `
                    <div class="table-row">
                        <div class="col" colspan="7">Failed to load transactions.</div>
                    </div>
                `;
                console.error(err);
            }
        });
        </script>

    <style>
        .transaction-filters-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .transaction-filters {
            display: flex;
            gap: 10px;
        }
        
        .export-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background-color 0.3s;
        }
        
        .export-btn:hover {
            background: #45a049;
            border: 1px solid #07610a;
            color: white;
        }
        
        .filter-tab {
            background: #f5f5f5;
            border: 1px solid #ddd;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .filter-tab.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }
        
        .filter-tab:hover {
            background: #e0e0e0;
        }
        
        .filter-tab.active:hover {
            background: #0056b3;
        }
    </style>
</body>
</html>